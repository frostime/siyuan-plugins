"use strict";const g=require("siyuan");function C(){}function it(t){return t()}function Ge(){return Object.create(null)}function G(t){t.forEach(it)}function st(t){return typeof t=="function"}function at(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function bt(t){return Object.keys(t).length===0}function s(t,e){t.appendChild(e)}function gt(t,e,n){const o=yt(t);if(!o.getElementById(e)){const l=c("style");l.id=e,l.textContent=n,vt(o,l)}}function yt(t){if(!t)return document;const e=t.getRootNode?t.getRootNode():t.ownerDocument;return e&&e.host?e:t.ownerDocument}function vt(t,e){return s(t.head||t,e),e.sheet}function X(t,e,n){t.insertBefore(e,n||null)}function K(t){t.parentNode&&t.parentNode.removeChild(t)}function wt(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function c(t){return document.createElement(t)}function $(t){return document.createTextNode(t)}function k(){return $(" ")}function T(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function h(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function kt(t){return Array.from(t.childNodes)}function A(t,e){e=""+e,t.data!==e&&(t.data=e)}function J(t,e,n){for(let o=0;o<t.options.length;o+=1){const l=t.options[o];if(l.__value===e){l.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function Oe(t){const e=t.querySelector(":checked");return e&&e.__value}function St(t,e,{bubbles:n=!1,cancelable:o=!1}={}){const l=document.createEvent("CustomEvent");return l.initCustomEvent(t,n,o,e),l}let Q;function Y(t){Q=t}function Ce(){if(!Q)throw new Error("Function called outside component initialization");return Q}function Nt(t){Ce().$$.on_mount.push(t)}function $t(t){Ce().$$.on_destroy.push(t)}function rt(){const t=Ce();return(e,n,{cancelable:o=!1}={})=>{const l=t.$$.callbacks[e];if(l){const i=St(e,n,{cancelable:o});return l.slice().forEach(a=>{a.call(t,i)}),!i.defaultPrevented}return!0}}const F=[],Ke=[];let W=[];const Ye=[],Mt=Promise.resolve();let Te=!1;function At(){Te||(Te=!0,Mt.then(ut))}function H(t){W.push(t)}const Ee=new Set;let V=0;function ut(){if(V!==0)return;const t=Q;do{try{for(;V<F.length;){const e=F[V];V++,Y(e),Et(e.$$)}}catch(e){throw F.length=0,V=0,e}for(Y(null),F.length=0,V=0;Ke.length;)Ke.pop()();for(let e=0;e<W.length;e+=1){const n=W[e];Ee.has(n)||(Ee.add(n),n())}W.length=0}while(F.length);for(;Ye.length;)Ye.pop()();Te=!1,Ee.clear(),Y(t)}function Et(t){if(t.fragment!==null){t.update(),G(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(H)}}function Dt(t){const e=[],n=[];W.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),W=e}const Ot=new Set;function Tt(t,e){t&&t.i&&(Ot.delete(t),t.i(e))}function Ct(t,e,n,o){const{fragment:l,after_update:i}=t.$$;l&&l.m(e,n),o||H(()=>{const a=t.$$.on_mount.map(it).filter(st);t.$$.on_destroy?t.$$.on_destroy.push(...a):G(a),t.$$.on_mount=[]}),i.forEach(H)}function It(t,e){const n=t.$$;n.fragment!==null&&(Dt(n.after_update),G(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function Lt(t,e){t.$$.dirty[0]===-1&&(F.push(t),At(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function ct(t,e,n,o,l,i,a,u=[-1]){const r=Q;Y(t);const d=t.$$={fragment:null,ctx:[],props:i,update:C,not_equal:l,bound:Ge(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(r?r.$$.context:[])),callbacks:Ge(),dirty:u,skip_bound:!1,root:e.target||r.$$.root};a&&a(d.root);let N=!1;if(d.ctx=n?n(t,e.props||{},(f,m,..._)=>{const v=_.length?_[0]:m;return d.ctx&&l(d.ctx[f],d.ctx[f]=v)&&(!d.skip_bound&&d.bound[f]&&d.bound[f](v),N&&Lt(t,f)),m}):[],d.update(),N=!0,G(d.before_update),d.fragment=o?o(d.ctx):!1,e.target){if(e.hydrate){const f=kt(e.target);d.fragment&&d.fragment.l(f),f.forEach(K)}else d.fragment&&d.fragment.c();e.intro&&Tt(t.$$.fragment),Ct(t,e.target,e.anchor,e.customElement),ut()}Y(r)}class dt{$destroy(){It(this,1),this.$destroy=C}$on(e,n){if(!st(n))return C;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const l=o.indexOf(n);l!==-1&&o.splice(l,1)}}$set(e){this.$$set&&!bt(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const Ie=g.clientApi.createLogger("OpenDiaryToday");function p(...t){Ie.info(...t)}function Le(...t){Ie.error(...t)}function xt(...t){Ie.warn(...t)}const ft={"zh-CN":{ToolbarAriaLabel:"今日笔记",Setting:[{title:"自动打开 Daily Note",text:"插件启动后自动打开今日的 Daily Note"},{title:"更新笔记本状态",text:"在笔记本配置发生变化的时候更新其状态，也可以使用注册的快捷键 Ctrl+Alt+U"},{title:"笔记本排序方案",text:"1. 和当前文档树的显示保持一致 2. 和在自定义排序中的设置保持一致",options:{"doc-tree":"和文档树一致","custom-sort":"和自定义排序一致"}},{title:"工具栏展示方案",text:"插件在工具栏上的显示方案，下拉框 or 图标，重启后生效",options:{select:"下拉选项框",menu:"菜单图标"}}],Open:"打开日记",Create:"创建日记",UpdateAll:"笔记本状态已更新",Menu:{Move:"移动到"}},"en-US":{ToolbarAriaLabel:"Daily Note Today",Setting:[{title:"Open Today's Diary Automatically",text:"Open Today's Diary automatically when the plugin is loaded"},{title:"Update Notebook Status",text:"Update the status of the notebook when the notebook configuration changes, or use the registered shortcut Ctrl+Alt+U"},{title:"Notebook Sorting Scheme",text:"1. Same what document tree shows 2. Same the order defined in custom sorting mode",options:{"doc-tree":"Same as document tree","custom-sort":"Same as custom sorting"}},{title:"Toolbar Display Scheme",text:"The display scheme of the plugin on the toolbar, drop-down selector or icon, effective after restart",options:{select:"Drop-down selector",menu:"Menu icon"}}],Open:"Open daily note",Create:"Create daily note",UpdateAll:"Notebook status updated",Menu:{Move:"Move to"}}};var nt,ot;const Qe=(ot=(nt=window==null?void 0:window.siyuan)==null?void 0:nt.config)==null?void 0:ot.lang;let ht=ft["zh-CN"];(Qe===void 0||!Qe.startsWith("zh"))&&(ht=ft["en-US"]);const x=ht;class Pt{constructor(){this.settings={OpenOnStart:!0,NotebookSort:"custom-sort",NotebookView:"Selector"}}setPlugin(e){this.plugin=e}get(e){var n;return(n=this.settings)==null?void 0:n[e]}set(e,n){if(!(e in this.settings)){Le(`Setting ${e} not found`);return}this.settings[e]=n}async load(){let e=await(this==null?void 0:this.plugin.loadStorage("DailyNoteToday.json"));if(p(`Read storage: ${e}`),e==null)this.save();else{e=JSON.parse(e);for(let n in this.settings)n in e&&(p(`Setting ${n} = ${e[n]}`),this.settings[n]=e[n])}}save(){let e=JSON.stringify(this.settings);p(`Write storage: ${e}`),this.plugin.writeStorage("DailyNoteToday.json",e)}}const S=new Pt;function qt(t){let e,n,o,l=t[0][0].title+"",i,a,u,r=t[0][0].text+"",d,N,f,m,_,v,b,E,Z=t[0][2].title+"",pe,Pe,ee,te=t[0][2].text+"",_e,qe,me,Ue,D,P,ne=t[0][2].options["custom-sort"]+"",be,q,oe=t[0][2].options["doc-tree"]+"",ge,Re,I,U,le=t[0][3].title+"",ye,Be,ie,se=t[0][3].text+"",ve,je,we,ze,O,R,ae=t[0][3].options.select+"",ke,B,re=t[0][3].options.menu+"",Se,Ve,L,j,ue=t[0][1].title+"",Ne,Fe,ce,de=t[0][1].text+"",$e,Je,Me,We,z,Ae,He;return{c(){e=c("div"),n=c("label"),o=c("div"),i=$(l),a=k(),u=c("div"),d=$(r),N=k(),f=c("span"),m=k(),_=c("input"),v=k(),b=c("label"),E=c("div"),pe=$(Z),Pe=k(),ee=c("div"),_e=$(te),qe=k(),me=c("span"),Ue=k(),D=c("select"),P=c("option"),be=$(ne),q=c("option"),ge=$(oe),Re=k(),I=c("label"),U=c("div"),ye=$(le),Be=k(),ie=c("div"),ve=$(se),je=k(),we=c("span"),ze=k(),O=c("select"),R=c("option"),ke=$(ae),B=c("option"),Se=$(re),Ve=k(),L=c("label"),j=c("div"),Ne=$(ue),Fe=k(),ce=c("div"),$e=$(de),Je=k(),Me=c("span"),We=k(),z=c("button"),z.textContent="Update",h(u,"class","b3-label__text"),h(o,"class","fn__flex-1"),h(f,"class","fn__space"),h(_,"class","b3-switch fn__flex-center"),h(_,"id","openDNOnStart"),h(_,"type","checkbox"),h(n,"class","fn__flex b3-label"),h(ee,"class","b3-label__text"),h(E,"class","fn__flex-1"),h(me,"class","fn__space"),P.__value="custom-sort",P.value=P.__value,q.__value="doc-tree",q.value=q.__value,h(D,"class","b3-select fn__flex-center fn__size200"),h(D,"id","notebookSort"),t[2]===void 0&&H(()=>t[7].call(D)),h(b,"class","fn__flex b3-label"),h(ie,"class","b3-label__text"),h(U,"class","fn__flex-1"),h(we,"class","fn__space"),R.__value="Selector",R.value=R.__value,B.__value="Menu",B.value=B.__value,h(O,"class","b3-select fn__flex-center fn__size200"),h(O,"id","NotebookView"),t[3]===void 0&&H(()=>t[9].call(O)),h(I,"class","fn__flex b3-label"),h(ce,"class","b3-label__text"),h(j,"class","fn__flex-1"),h(Me,"class","fn__space"),h(z,"class","b3-button b3-button--outline fn__flex-center fn__size200"),h(z,"id","updateNotebookStatus"),h(L,"class","fn__flex b3-label"),h(e,"class","config__tab-container")},m(y,w){X(y,e,w),s(e,n),s(n,o),s(o,i),s(o,a),s(o,u),s(u,d),s(n,N),s(n,f),s(n,m),s(n,_),_.checked=t[1],s(e,v),s(e,b),s(b,E),s(E,pe),s(E,Pe),s(E,ee),s(ee,_e),s(b,qe),s(b,me),s(b,Ue),s(b,D),s(D,P),s(P,be),s(D,q),s(q,ge),J(D,t[2],!0),s(e,Re),s(e,I),s(I,U),s(U,ye),s(U,Be),s(U,ie),s(ie,ve),s(I,je),s(I,we),s(I,ze),s(I,O),s(O,R),s(R,ke),s(O,B),s(B,Se),J(O,t[3],!0),s(e,Ve),s(e,L),s(L,j),s(j,Ne),s(j,Fe),s(j,ce),s(ce,$e),s(L,Je),s(L,Me),s(L,We),s(L,z),Ae||(He=[T(_,"change",t[5]),T(_,"change",t[6]),T(D,"change",t[7]),T(D,"change",t[8]),T(O,"change",t[9]),T(O,"change",t[10]),T(z,"click",t[4])],Ae=!0)},p(y,[w]){w&1&&l!==(l=y[0][0].title+"")&&A(i,l),w&1&&r!==(r=y[0][0].text+"")&&A(d,r),w&2&&(_.checked=y[1]),w&1&&Z!==(Z=y[0][2].title+"")&&A(pe,Z),w&1&&te!==(te=y[0][2].text+"")&&A(_e,te),w&1&&ne!==(ne=y[0][2].options["custom-sort"]+"")&&A(be,ne),w&1&&oe!==(oe=y[0][2].options["doc-tree"]+"")&&A(ge,oe),w&4&&J(D,y[2]),w&1&&le!==(le=y[0][3].title+"")&&A(ye,le),w&1&&se!==(se=y[0][3].text+"")&&A(ve,se),w&1&&ae!==(ae=y[0][3].options.select+"")&&A(ke,ae),w&1&&re!==(re=y[0][3].options.menu+"")&&A(Se,re),w&8&&J(O,y[3]),w&1&&ue!==(ue=y[0][1].title+"")&&A(Ne,ue),w&1&&de!==(de=y[0][1].text+"")&&A($e,de)},i:C,o:C,d(y){y&&K(e),Ae=!1,G(He)}}}function Ut(t,e,n){let o=S.get("OpenOnStart"),l=S.get("NotebookSort"),i=S.get("NotebookView");const a=rt();let{contents:u}=e;function r(){a("updateAll")}$t(()=>{S.save()});function d(){o=this.checked,n(1,o)}const N=b=>{S.set("OpenOnStart",b.target.checked),S.save()};function f(){l=Oe(this),n(2,l)}const m=b=>{let E=b.target.value;S.set("NotebookSort",E),S.save()};function _(){i=Oe(this),n(3,i)}const v=b=>{let E=b.target.value;S.set("NotebookView",E),S.save()};return t.$$set=b=>{"contents"in b&&n(0,u=b.contents)},[u,o,l,i,r,d,N,f,m,_,v]}class Rt extends dt{constructor(e){super(),ct(this,e,Ut,qt,at,{contents:0})}}class Bt{constructor(){this.notebooks=[]}get(e){return this.notebooks[e]}set(e,n){this.notebooks[e]=n}[Symbol.iterator](){return this.notebooks[Symbol.iterator]()}async init(e=5,n=1e3){let o=0;for(;o<e;){let l=await Xe();if(l!=null){this.notebooks=l;break}else await new Promise(i=>setTimeout(i,n));o++}}async update(){let e=await Xe();this.notebooks=e||[]}}const M=new Bt;var lt;let jt=(lt=window.siyuan)==null?void 0:lt.config.api.token;async function zt(t,e){let o=await(await fetch(t,{body:JSON.stringify(e),method:"POST",headers:{Authorization:`Token ${jt}`}})).json();return o&&(o==null?void 0:o.code)===0?o.data:null}const De='/daily note/{{now | date "2006/01"}}/{{now | date "2006-01-02"}}',Vt=new Set(["思源笔记用户指南","SiYuan User Guide"]);async function Ft(t){let e=`select * from blocks where parent_id = '${t}'`;return await g.serverApi.sql(e)}async function pt(t,e,n="parent"){let o=new Array;t.type=="h"&&(o=await Ft(t.id));let l;n=="parent"?l=await g.serverApi.moveBlock(t.id,null,e):n=="previous"&&(l=await g.serverApi.moveBlock(t.id,e,null)),console.log("Move ans:",l);let i=t.id;for(let a of o){let u=a.id;a.type!="h"?(l=await g.serverApi.moveBlock(u,i,null),i=u):i=await pt(a,i,"previous")}return i}async function Jt(t,e){let n=await g.serverApi.getBlockByID(t);if(n==null){Le(`Block ${t} not found`);return}let o=e.dailynotePath,l=await xe(o,e),i;l!=null&&l.length>0?i=l[0].id:(i=await mt(e,o),fe(`${x.Create}: ${e.name}`,"info",2500)),pt(n,i,"parent")}async function fe(t,e="info",n=1e3){new g.Notification({type:e,message:t,timeout:n}).show()}async function Xe(){try{let e=(await g.serverApi.lsNotebooks("")).notebooks;e=e.filter(o=>!o.closed&&!Vt.has(o.name)),S.settings.NotebookSort=="custom-sort"&&(e=e.sort((o,l)=>o.sort-l.sort));let n=e.map(o=>o.name);for(let o of e){let l=await Wt(o.id);o.dailynoteSprig=l!=""?l:De,o.dailynotePath=await Ze(o.dailynoteSprig),o.dailynotePath==""&&(xt(`Invalid daily note srpig of ${o.name}`),o.dailynoteSprig=De,o.dailynotePath=await Ze(De)),o.icon==""&&(o.icon="1f5c3"),p(`${o.name}: ${o.dailynoteSprig} - ${o.dailynotePath}`)}return p(`Read all notebooks: ${n}`),e}catch(t){return Le(t),null}}async function _t(){p("updateDiaryStatus");let t=new Set;M.notebooks.forEach(o=>{t.add(o.dailynotePath)});let e=new Map,n=0;for(const o of t){let l=await xe(o);if(l.length>0){let i=l.map(a=>a.box);i.forEach(a=>{e.set(a,!0)}),n+=i.length,p(`${o} 共 ${i.length} 篇`)}}return p(`当前日记共 ${n} 篇`),e}async function Wt(t){return(await g.serverApi.getNotebookConf(t)).conf.dailyNoteSavePath}async function Ht(t){return await zt("/api/template/renderSprig",{template:t})}async function Ze(t){return await Ht(t)}async function xe(t,e=null){let n=`select * from blocks where type='d' and hpath = '${t}'`;return e!=null&&(n=`select * from blocks where type='d' and hpath = '${t}' and box = '${e.id}'`),await g.serverApi.sql(n)}async function mt(t,e){p(`Try to create: ${t.name} ${e}`);let n=await g.serverApi.createDocWithMd(t.id,e,"");return p(`Create new diary ${n}`),n}async function he(t){let e=t.dailynotePath;p(`Open ${t.name}/${e}`);let n=await xe(e,t);if(n!=null&&n.length>0){let l=n[0].id;window.open(`siyuan://blocks/${l}`),fe(`${x.Open}： ${t.name}`,"info",1500)}else{let o=await mt(t,e);window.open(`siyuan://blocks/${o}`),fe(`${x.Create}: ${t.name}`,"info",1500)}}const Gt="toolbar__item b3-tooltips b3-tooltips__sw";class Kt{constructor(){this.icons=new Map,this.ele=document.createElement("div"),this.ele.setAttribute("aria-label",x.ToolbarAriaLabel),this.ele.classList.add(...Gt.split(/\s/));let e='<svg><use xlink:href="#iconCalendar"></use></svg>';this.ele.innerHTML=e,this.ele.addEventListener("click",this.showMenu.bind(this)),g.clientApi.addToolbarRight(this.ele)}release(){this.ele.removeEventListener("click",this.showMenu.bind(this)),this.ele.remove()}async showMenu(e){p("点击了今日日记按钮");let n=new g.Menu("dntoday-menu"),o=this.createMenuItems();for(let l of o)n.addItem(new g.MenuItem(l));n.showAtMouseEvent(e),e.stopPropagation(),this.updateDailyNoteStatus()}createMenuItems(){let e=[];for(let n of M){let o={label:n.name,icon:this.icons.get(n.id),click:l=>{he(n)}};e.push(o)}return e}autoOpenDailyNote(){M.notebooks.length>0&&S.settings.OpenOnStart===!0&&he(M.get(0))}updateNotebookStatus(){this.menu=new g.Menu("dntoday-menu");let e=this.createMenuItems();for(let n of e)this.menu.addItem(new g.MenuItem(n))}async updateDailyNoteStatus(){let e=await _t();M.notebooks.forEach(n=>{e.get(n.id)?this.icons.set(n.id,"iconSelect"):this.icons.set(n.id,"")})}}function Yt(t){gt(t,"svelte-q6yblf","select.svelte-q6yblf{margin:0;min-width:8rem !important;height:100%}")}function et(t,e,n){const o=t.slice();return o[11]=e[n],o}function Qt(t){let e;return{c(){e=c("span"),e.textContent=`${t[3][1]}`},m(n,o){X(n,e,o)},p:C,d(n){n&&K(e)}}}function Xt(t){let e;return{c(){e=c("span"),e.textContent=`${t[3][0]}`},m(n,o){X(n,e,o)},p:C,d(n){n&&K(e)}}}function tt(t){let e,n,o,l,i=t[11].name+"",a,u,r;function d(m,_){return _&6&&(n=null),n==null&&(n=m[2].get(m[11].id)===!0),n?Xt:Qt}let N=d(t,-1),f=N(t);return{c(){e=c("option"),f.c(),o=k(),l=c("span"),a=$(i),u=k(),e.__value=r=t[11].id,e.value=e.__value},m(m,_){X(m,e,_),f.m(e,null),s(e,o),s(e,l),s(l,a),s(e,u)},p(m,_){N===(N=d(m,_))&&f?f.p(m,_):(f.d(1),f=N(m),f&&(f.c(),f.m(e,o))),_&2&&i!==(i=m[11].name+"")&&A(a,i),_&2&&r!==(r=m[11].id)&&(e.__value=r,e.value=e.__value)},d(m){m&&K(e),f.d()}}}function Zt(t){let e,n,o,l=t[1],i=[];for(let a=0;a<l.length;a+=1)i[a]=tt(et(t,l,a));return{c(){e=c("select");for(let a=0;a<i.length;a+=1)i[a].c();h(e,"class","b3-select svelte-q6yblf"),t[0]===void 0&&H(()=>t[6].call(e))},m(a,u){X(a,e,u);for(let r=0;r<i.length;r+=1)i[r]&&i[r].m(e,null);J(e,t[0],!0),n||(o=[T(e,"click",t[4]),T(e,"blur",t[5]),T(e,"change",t[6])],n=!0)},p(a,[u]){if(u&14){l=a[1];let r;for(r=0;r<l.length;r+=1){const d=et(a,l,r);i[r]?i[r].p(d,u):(i[r]=tt(d),i[r].c(),i[r].m(e,null))}for(;r<i.length;r+=1)i[r].d(1);i.length=l.length}u&3&&J(e,a[0])},i:C,o:C,d(a){a&&K(e),wt(i,a),n=!1,G(o)}}}function en(t,e,n){const o=rt();let{notebooks:l=new Array}=e,{diaryStatus:i=new Map}=e,{selected:a=""}=e;Nt(()=>{l.length>0&&n(0,a=l[0].id)});let u=!0;const r=["✓","  "];function d(v){if(p("Event: click"),u)u=!1,f();else{let b=v.target.value;m(b),u=!0}}function N(){p("Event: blur"),u=!0}function f(){p("Event: openNotebook"),o("openSelector")}function m(v){p("Event: openDiary");let b=l.find(E=>E.id===v);o("openDiary",{notebook:b})}function _(){a=Oe(this),n(0,a),n(1,l)}return t.$$set=v=>{"notebooks"in v&&n(1,l=v.notebooks),"diaryStatus"in v&&n(2,i=v.diaryStatus),"selected"in v&&n(0,a=v.selected)},t.$$.update=()=>{t.$$.dirty&1&&p("当前选中",a)},[a,l,i,r,d,N,_]}class tn extends dt{constructor(e){super(),ct(this,e,en,Zt,at,{notebooks:1,diaryStatus:2,selected:0},Yt)}}const nn="toolbar__item b3-tooltips b3-tooltips__sw";class on{constructor(){this.ele=document.createElement("div"),this.ele.setAttribute("aria-label",x.ToolbarAriaLabel),this.ele.classList.add(...nn.split(/\s/)),this.ele.style.margin="0 0.1rem",this.ele.style.padding="0rem 0rem",this.component_select=new tn({target:this.ele,props:{notebooks:M.notebooks}}),this.component_select.$on("openSelector",this.updateDailyNoteStatus.bind(this)),this.component_select.$on("openDiary",async e=>{await he(e.detail.notebook),this.updateDailyNoteStatus()}),g.clientApi.addToolbarRight(this.ele)}release(){this.component_select.$destroy(),this.ele.remove(),p("ToolbarSelectItem released")}autoOpenDailyNote(){M.notebooks.length>0&&(this.component_select.$set({selected:M.get(0).id}),S.settings.OpenOnStart===!0&&he(M.get(0)))}updateNotebookStatus(){this.component_select.$set({notebooks:M.notebooks}),this.component_select.$set({selected:M.get(0).id})}async updateDailyNoteStatus(){let e=await _t();this.component_select.$set({diaryStatus:e})}}class ln{constructor(){this.observer=null}async bindMenuOnCurrentTabs(){let e=document.querySelector("div.protyle-gutters");e==null||e.addEventListener("contextmenu",this.gutterContextMenuEvent.bind(this))}addEditorTabObserver(){let e=document.querySelector("#layouts div.layout__center div.layout-tab-container"),n=o=>{this.gutterContextMenuEvent(o)};this.observer=new MutationObserver(function(o){for(var l of o){if(l.type=="childList"&&l.addedNodes.length)for(let i of l.addedNodes){let a=i,u=a.querySelector("div.protyle-gutters");u==null||u.addEventListener("contextmenu",n);let r=a.getAttribute("data-id");p(`Add Listener: protyle-${r}`)}if(l.type=="childList"&&l.removedNodes.length)for(let i of l.removedNodes){let a=i,u=a.querySelector("div.protyle-gutters");u==null||u.removeEventListener("contextmenu",n);let r=a.getAttribute("data-id");p(`Remove Listener: protyle-${r}`)}}}),e&&this.observer.observe(e,{childList:!0,attributes:!1,characterData:!1,subtree:!1})}removeEditorTabObserver(){this.observer&&this.observer.disconnect()}gutterContextMenuEvent(e){let n=e.target,o=e.currentTarget;for(;n!=o&&n.tagName!=="BUTTON";)if(n.parentElement)n=n.parentElement;else break;let l=n.getAttribute("data-node-id");if(l&&e.altKey){p(`Contextemnu on: ${l}`);let i=new g.Menu("MoveMenu");i.addItem(new g.MenuItem({label:x.Menu.Move,type:"submenu",icon:"iconMove",submenu:this.createMenuItems(l)})),i.showAtMouseEvent(e)}}createMenuItems(e){let n=[];for(let o of M){let l={label:o.name,icon:`icon-${o.icon}`,click:i=>{p(`Move ${e} to ${o.id}`),Jt(e,o)}};n.push(l)}return n}}class sn extends g.Plugin{constructor(){super(),p(`Start: ${new Date}`),S.setPlugin(this)}async onload(){let e=performance.now();await M.init(),this.registerCommand({command:"updateAll",shortcut:"ctrl+alt+u,command+option+u",description:"全局更新",callback:this.updateAll.bind(this)}),await S.load(),this.initSetting(),this.initMenu(),this.initToolbarItem(),this.toolbar_item.autoOpenDailyNote(),this.toolbar_item.updateDailyNoteStatus();let n=performance.now();p(`Onload, 耗时: ${n-e} ms`)}initSetting(){this.div_setting=document.createElement("div"),this.component_setting=new Rt({target:this.div_setting,props:{contents:x.Setting}}),this.registerSettingRender(e=>{e.appendChild(this.div_setting)}),this.component_setting.$on("updateAll",()=>{this.updateAll()})}initMenu(){this.menu=new ln,this.menu.bindMenuOnCurrentTabs(),this.menu.addEditorTabObserver()}initToolbarItem(){S.settings.NotebookView==="Selector"?this.toolbar_item=new on:this.toolbar_item=new Kt,this.toolbar_item.updateNotebookStatus(),g.clientApi.addToolbarRight(this.toolbar_item.ele)}async updateAll(){p("updateAll"),await M.update(),this.toolbar_item.updateNotebookStatus(),this.toolbar_item.updateDailyNoteStatus(),this.menu.bindMenuOnCurrentTabs(),fe(x.UpdateAll,"info",2500)}onunload(){p("plugin unload"),this.toolbar_item.release(),this.menu.removeEditorTabObserver(),S.save()}}module.exports=sn;
