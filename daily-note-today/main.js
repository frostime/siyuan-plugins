"use strict";const b=require("siyuan");function D(){}function Re(t){return t()}function $e(){return Object.create(null)}function I(t){t.forEach(Re)}function Ue(t){return typeof t=="function"}function Be(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function Ge(t){return Object.keys(t).length===0}function r(t,e){t.appendChild(e)}function He(t,e,n){const o=Ke(t);if(!o.getElementById(e)){const i=f("style");i.id=e,i.textContent=n,Qe(o,i)}}function Ke(t){if(!t)return document;const e=t.getRootNode?t.getRootNode():t.ownerDocument;return e&&e.host?e:t.ownerDocument}function Qe(t,e){return r(t.head||t,e),e.sheet}function J(t,e,n){t.insertBefore(e,n||null)}function j(t){t.parentNode&&t.parentNode.removeChild(t)}function Ve(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function f(t){return document.createElement(t)}function k(t){return document.createTextNode(t)}function m(){return k(" ")}function Ze(){return k("")}function M(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function p(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function et(t){return Array.from(t.childNodes)}function $(t,e){e=""+e,t.data!==e&&(t.data=e)}function Ne(t,e,n){for(let o=0;o<t.options.length;o+=1){const i=t.options[o];if(i.__value===e){i.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function tt(t){const e=t.querySelector(":checked");return e&&e.__value}function nt(t,e,{bubbles:n=!1,cancelable:o=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(t,n,o,e),i}let F;function z(t){F=t}function ot(){if(!F)throw new Error("Function called outside component initialization");return F}function Ie(){const t=ot();return(e,n,{cancelable:o=!1}={})=>{const i=t.$$.callbacks[e];if(i){const l=nt(e,n,{cancelable:o});return i.slice().forEach(s=>{s.call(t,l)}),!l.defaultPrevented}return!0}}const R=[],Oe=[];let U=[];const Ae=[],it=Promise.resolve();let fe=!1;function lt(){fe||(fe=!0,it.then(je))}function Z(t){U.push(t)}const ue=new Set;let L=0;function je(){if(L!==0)return;const t=F;do{try{for(;L<R.length;){const e=R[L];L++,z(e),st(e.$$)}}catch(e){throw R.length=0,L=0,e}for(z(null),R.length=0,L=0;Oe.length;)Oe.pop()();for(let e=0;e<U.length;e+=1){const n=U[e];ue.has(n)||(ue.add(n),n())}U.length=0}while(R.length);for(;Ae.length;)Ae.pop()();fe=!1,ue.clear(),z(t)}function st(t){if(t.fragment!==null){t.update(),I(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(Z)}}function at(t){const e=[],n=[];U.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),U=e}const rt=new Set;function ct(t,e){t&&t.i&&(rt.delete(t),t.i(e))}function ut(t,e,n,o){const{fragment:i,after_update:l}=t.$$;i&&i.m(e,n),o||Z(()=>{const s=t.$$.on_mount.map(Re).filter(Ue);t.$$.on_destroy?t.$$.on_destroy.push(...s):I(s),t.$$.on_mount=[]}),l.forEach(Z)}function dt(t,e){const n=t.$$;n.fragment!==null&&(at(n.after_update),I(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function ft(t,e){t.$$.dirty[0]===-1&&(R.push(t),lt(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function ze(t,e,n,o,i,l,s,c=[-1]){const a=F;z(t);const u=t.$$={fragment:null,ctx:[],props:l,update:D,not_equal:i,bound:$e(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(a?a.$$.context:[])),callbacks:$e(),dirty:c,skip_bound:!1,root:e.target||a.$$.root};s&&s(u.root);let d=!1;if(u.ctx=n?n(t,e.props||{},(_,E,...y)=>{const g=y.length?y[0]:E;return u.ctx&&i(u.ctx[_],u.ctx[_]=g)&&(!u.skip_bound&&u.bound[_]&&u.bound[_](g),d&&ft(t,_)),E}):[],u.update(),d=!0,I(u.before_update),u.fragment=o?o(u.ctx):!1,e.target){if(e.hydrate){const _=et(e.target);u.fragment&&u.fragment.l(_),_.forEach(j)}else u.fragment&&u.fragment.c();e.intro&&ct(t.$$.fragment),ut(t,e.target,e.anchor,e.customElement),je()}z(a)}class Fe{$destroy(){dt(this,1),this.$destroy=D}$on(e,n){if(!Ue(n))return D;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(e){this.$$set&&!Ge(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const he=b.clientApi.createLogger("OpenDiaryToday");function h(...t){he.info(...t)}function pe(...t){he.error(...t)}function ht(...t){he.warn(...t)}const Je={"zh-CN":{Setting:[{title:"自动打开 Daily Note",text:"插件启动后自动打开今日的 Daily Note"},{title:"更新笔记本状态",text:"在笔记本配置发生变化的时候更新其状态，也可以使用注册的快捷键 Ctrl+Alt+U"},{title:"笔记本排序方案",text:"1. 和当前文档树的显示保持一致 2. 和在自定义排序中的设置保持一致",options:{"doc-tree":"和文档树一致","custom-sort":"和自定义排序一致"}}],Open:"打开日记",Create:"创建日记",UpdateAll:"笔记本状态已更新",Menu:{Move:"移动到"}},"en-US":{Setting:[{title:"Open Today's Diary Automatically",text:"Open Today's Diary automatically when the plugin is loaded"},{title:"Update Notebook Status",text:"Update the status of the notebook when the notebook configuration changes, or use the registered shortcut Ctrl+Alt+U"},{title:"Notebook Sorting Scheme",text:"1. Same what document tree shows 2. Same the order defined in custom sorting mode",options:{"doc-tree":"Same as document tree","custom-sort":"Same as custom sorting"}}],Open:"Open daily note",Create:"Create daily note",UpdateAll:"Notebook status updated",Menu:{Move:"Move to"}}};var Pe,qe;const Ee=(qe=(Pe=window==null?void 0:window.siyuan)==null?void 0:Pe.config)==null?void 0:qe.lang;let We=Je["zh-CN"];(Ee===void 0||!Ee.startsWith("zh"))&&(We=Je["en-US"]);const B=We;function pt(t){He(t,"svelte-q6yblf","select.svelte-q6yblf{margin:0;min-width:8rem !important;height:100%}")}function Ce(t,e,n){const o=t.slice();return o[11]=e[n],o}function _t(t){let e,n,o,i,l=t[11].name+"",s,c,a;return{c(){e=f("option"),n=f("span"),n.textContent=`${t[3][1]}`,o=m(),i=f("span"),s=k(l),c=m(),e.__value=a=t[11].id,e.value=e.__value},m(u,d){J(u,e,d),r(e,n),r(e,o),r(e,i),r(i,s),r(e,c)},p(u,d){d&2&&l!==(l=u[11].name+"")&&$(s,l),d&2&&a!==(a=u[11].id)&&(e.__value=a,e.value=e.__value)},d(u){u&&j(e)}}}function gt(t){let e,n,o,i,l=t[11].name+"",s,c,a;return{c(){e=f("option"),n=f("span"),n.textContent=`${t[3][0]}`,o=m(),i=f("span"),s=k(l),c=m(),e.__value=a=t[11].id,e.value=e.__value},m(u,d){J(u,e,d),r(e,n),r(e,o),r(e,i),r(i,s),r(e,c)},p(u,d){d&2&&l!==(l=u[11].name+"")&&$(s,l),d&2&&a!==(a=u[11].id)&&(e.__value=a,e.value=e.__value)},d(u){u&&j(e)}}}function Me(t){let e,n;function o(s,c){return c&6&&(e=null),e==null&&(e=!s[11].closed&&s[2].get(s[11].id)===!0),e?gt:_t}let i=o(t,-1),l=i(t);return{c(){l.c(),n=Ze()},m(s,c){l.m(s,c),J(s,n,c)},p(s,c){i===(i=o(s,c))&&l?l.p(s,c):(l.d(1),l=i(s),l&&(l.c(),l.m(n.parentNode,n)))},d(s){l.d(s),s&&j(n)}}}function mt(t){let e,n,o,i=t[1],l=[];for(let s=0;s<i.length;s+=1)l[s]=Me(Ce(t,i,s));return{c(){e=f("select");for(let s=0;s<l.length;s+=1)l[s].c();p(e,"class","b3-select svelte-q6yblf"),t[0]===void 0&&Z(()=>t[6].call(e))},m(s,c){J(s,e,c);for(let a=0;a<l.length;a+=1)l[a]&&l[a].m(e,null);Ne(e,t[0],!0),n||(o=[M(e,"click",t[4]),M(e,"blur",t[5]),M(e,"change",t[6])],n=!0)},p(s,[c]){if(c&14){i=s[1];let a;for(a=0;a<i.length;a+=1){const u=Ce(s,i,a);l[a]?l[a].p(u,c):(l[a]=Me(u),l[a].c(),l[a].m(e,null))}for(;a<l.length;a+=1)l[a].d(1);l.length=i.length}c&3&&Ne(e,s[0])},i:D,o:D,d(s){s&&j(e),Ve(l,s),n=!1,I(o)}}}function bt(t,e,n){const o=Ie();let{notebooks:i=new Array}=e,{diaryStatus:l=new Map}=e,{selected:s=""}=e,c=!0;const a=["✓","  "];function u(g){if(h("Event: click"),c)c=!1,_();else{let w=g.target.value;E(w),c=!0}}function d(){h("Event: blur"),c=!0}function _(){h("Event: openNotebook"),o("openSelector")}function E(g){h("Event: openDiary");let w=i.find(O=>O.id===g);o("openDiary",{notebook:w})}function y(){s=tt(this),n(0,s),n(1,i)}return t.$$set=g=>{"notebooks"in g&&n(1,i=g.notebooks),"diaryStatus"in g&&n(2,l=g.diaryStatus),"selected"in g&&n(0,s=g.selected)},t.$$.update=()=>{t.$$.dirty&1&&h("当前选中",s)},[s,i,l,a,u,d,y]}class yt extends Fe{constructor(e){super(),ze(this,e,bt,mt,Be,{notebooks:1,diaryStatus:2,selected:0},pt)}}class vt{constructor(){this.settings={OpenOnStart:!0,NotebookSort:"custom-sort"}}setPlugin(e){this.plugin=e}get(e){var n;return(n=this.settings)==null?void 0:n[e]}set(e,n){if(!(e in this.settings)){pe(`Setting ${e} not found`);return}this.settings[e]=n}async load(){let e=await(this==null?void 0:this.plugin.loadStorage("DailyNoteToday.json"));if(h(`Read storage: ${e}`),e==null)this.save();else{e=JSON.parse(e);let n=e==null?void 0:e.OpenOnStart;n!=null&&this.set("OpenOnStart",n)}}save(){let e=JSON.stringify(this.settings);h(`Write storage: ${e}`),this.plugin.writeStorage("DailyNoteToday.json",e)}}const N=new vt;function wt(t){let e,n,o,i=t[0][0].title+"",l,s,c,a=t[0][0].text+"",u,d,_,E,y,g,w,O,W=t[0][2].title+"",te,ge,Y,X=t[0][2].text+"",ne,me,oe,be,C,x,G=t[0][2].options["custom-sort"]+"",ie,T,H=t[0][2].options["doc-tree"]+"",le,ye,A,P,K=t[0][1].title+"",se,ve,Q,V=t[0][1].text+"",ae,we,re,ke,q,ce,Se;return{c(){e=f("div"),n=f("label"),o=f("div"),l=k(i),s=m(),c=f("div"),u=k(a),d=m(),_=f("span"),E=m(),y=f("input"),g=m(),w=f("label"),O=f("div"),te=k(W),ge=m(),Y=f("div"),ne=k(X),me=m(),oe=f("span"),be=m(),C=f("select"),x=f("option"),ie=k(G),T=f("option"),le=k(H),ye=m(),A=f("label"),P=f("div"),se=k(K),ve=m(),Q=f("div"),ae=k(V),we=m(),re=f("span"),ke=m(),q=f("button"),q.textContent="Update",p(c,"class","b3-label__text"),p(o,"class","fn__flex-1"),p(_,"class","fn__space"),p(y,"class","b3-switch fn__flex-center"),p(y,"id","openDNOnStart"),p(y,"type","checkbox"),p(n,"class","fn__flex b3-label"),p(Y,"class","b3-label__text"),p(O,"class","fn__flex-1"),p(oe,"class","fn__space"),x.__value="custom-sort",x.value=x.__value,T.__value="doc-tree",T.value=T.__value,p(C,"class","b3-select fn__flex-center fn__size200"),p(C,"id","notebookSort"),p(w,"class","fn__flex b3-label"),p(Q,"class","b3-label__text"),p(P,"class","fn__flex-1"),p(re,"class","fn__space"),p(q,"class","b3-button b3-button--outline fn__flex-center fn__size200"),p(q,"id","updateNotebookStatus"),p(A,"class","fn__flex b3-label"),p(e,"class","config__tab-container")},m(v,S){J(v,e,S),r(e,n),r(n,o),r(o,l),r(o,s),r(o,c),r(c,u),r(n,d),r(n,_),r(n,E),r(n,y),y.checked=t[1],r(e,g),r(e,w),r(w,O),r(O,te),r(O,ge),r(O,Y),r(Y,ne),r(w,me),r(w,oe),r(w,be),r(w,C),r(C,x),r(x,ie),r(C,T),r(T,le),r(e,ye),r(e,A),r(A,P),r(P,se),r(P,ve),r(P,Q),r(Q,ae),r(A,we),r(A,re),r(A,ke),r(A,q),ce||(Se=[M(y,"change",t[3]),M(y,"change",t[4]),M(C,"change",t[5]),M(q,"click",t[2])],ce=!0)},p(v,[S]){S&1&&i!==(i=v[0][0].title+"")&&$(l,i),S&1&&a!==(a=v[0][0].text+"")&&$(u,a),S&2&&(y.checked=v[1]),S&1&&W!==(W=v[0][2].title+"")&&$(te,W),S&1&&X!==(X=v[0][2].text+"")&&$(ne,X),S&1&&G!==(G=v[0][2].options["custom-sort"]+"")&&$(ie,G),S&1&&H!==(H=v[0][2].options["doc-tree"]+"")&&$(le,H),S&1&&K!==(K=v[0][1].title+"")&&$(se,K),S&1&&V!==(V=v[0][1].text+"")&&$(ae,V)},i:D,o:D,d(v){v&&j(e),ce=!1,I(Se)}}}function kt(t,e,n){let o=N.get("OpenOnStart");const i=Ie();let{contents:l}=e;function s(){i("updateAll")}function c(){o=this.checked,n(1,o)}const a=d=>{console.log("Checked: "+d.target.checked),N.set("OpenOnStart",d.target.checked),N.save()},u=d=>{console.log("setting"),console.log(d);let _=d.target.value;N.set("NotebookSort",_),N.save()};return t.$$set=d=>{"contents"in d&&n(0,l=d.contents)},[l,o,s,c,a,u]}class St extends Fe{constructor(e){super(),ze(this,e,kt,wt,Be,{contents:0})}}var Le;let $t=(Le=window.siyuan)==null?void 0:Le.config.api.token;async function Nt(t,e){let o=await(await fetch(t,{body:JSON.stringify(e),method:"POST",headers:{Authorization:`Token ${$t}`}})).json();return o&&(o==null?void 0:o.code)===0?o.data:null}const de='/daily note/{{now | date "2006/01"}}/{{now | date "2006-01-02"}}',Ot=new Set(["思源笔记用户指南","SiYuan User Guide"]);async function At(t){let e=`select * from blocks where parent_id = '${t}'`;return await b.serverApi.sql(e)}async function Ye(t,e,n="parent"){let o=new Array;t.type=="h"&&(o=await At(t.id));let i;n=="parent"?i=await b.serverApi.moveBlock(t.id,null,e):n=="previous"&&(i=await b.serverApi.moveBlock(t.id,e,null)),console.log("Move ans:",i);let l=t.id;for(let s of o){let c=s.id;s.type!="h"?(i=await b.serverApi.moveBlock(c,l,null),l=c):l=await Ye(s,l,"previous")}return l}async function Et(t,e){let n=await b.serverApi.getBlockByID(t);if(n==null){pe(`Block ${t} not found`);return}let o=e.dailynotePath,i=await _e(o,e),l;i!=null&&i.length>0?l=i[0].id:(l=await Xe(e,o),ee(`${B.Create}: ${e.name}`,"info",2500)),Ye(n,l,"parent")}async function ee(t,e="info",n=1e3){new b.Notification({type:e,message:t,timeout:n}).show()}async function De(){try{let e=(await b.serverApi.lsNotebooks("")).notebooks;e=e.filter(o=>!o.closed&&!Ot.has(o.name)),N.settings.NotebookSort=="custom-sort"&&(e=e.sort((o,i)=>o.sort-i.sort));let n=e.map(o=>o.name);for(let o of e){let i=await Ct(o.id);o.dailynoteSprig=i!=""?i:de,o.dailynotePath=await xe(o.dailynoteSprig),o.dailynotePath==""&&(ht(`Invalid daily note srpig of ${o.name}`),o.dailynoteSprig=de,o.dailynotePath=await xe(de)),o.icon==""&&(o.icon="1f5c3"),h(`${o.name}: ${o.dailynoteSprig} - ${o.dailynotePath}`)}return h(`Read all notebooks: ${n}`),e}catch(t){return pe(t),null}}async function Ct(t){return(await b.serverApi.getNotebookConf(t)).conf.dailyNoteSavePath}async function Mt(t){return await Nt("/api/template/renderSprig",{template:t})}async function xe(t){return await Mt(t)}async function _e(t,e=null){let n=`select * from blocks where type='d' and hpath = '${t}'`;return e!=null&&(n=`select * from blocks where type='d' and hpath = '${t}' and box = '${e.id}'`),await b.serverApi.sql(n)}async function Xe(t,e){h(`Try to create: ${t.name} ${e}`);let n=await b.serverApi.createDocWithMd(t.id,e,"");return h(`Create new diary ${n}`),n}async function Te(t){let e=t.dailynotePath;h(`Open ${t.name}/${e}`);let n=await _e(e,t);if(n!=null&&n.length>0){let i=n[0].id;window.open(`siyuan://blocks/${i}`),ee(`${B.Open}： ${t.name}`,"info",2500)}else{let o=await Xe(t,e);window.open(`siyuan://blocks/${o}`),ee(`${B.Create}: ${t.name}`,"info",2500)}}class Dt{constructor(e){this.notebooks=e}async bindMenuOnCurrentTabs(){let e=document.querySelector("div.protyle-gutters");e==null||e.addEventListener("contextmenu",this.gutterContextMenuEvent.bind(this))}addEditorTabObserver(){let e=document.querySelector("#layouts div.layout__center div.layout-tab-container"),n=i=>{this.gutterContextMenuEvent(i)};var o=new MutationObserver(function(i){for(var l of i){if(l.type=="childList"&&l.addedNodes.length)for(let s of l.addedNodes){let c=s,a=c.querySelector("div.protyle-gutters");a==null||a.addEventListener("contextmenu",n),h(`Add Listener: ${c}`)}if(l.type=="childList"&&l.removedNodes.length)for(let s of l.removedNodes){let c=s,a=c.querySelector("div.protyle-gutters");a==null||a.removeEventListener("contextmenu",n),h(`Remove Listener: ${c}`)}}});e&&o.observe(e,{childList:!0,attributes:!1,characterData:!1,subtree:!1})}gutterContextMenuEvent(e){let n=e.target,o=e.currentTarget;for(;n!=o&&n.tagName!=="BUTTON";)if(n.parentElement)n=n.parentElement;else break;let i=n.getAttribute("data-node-id");if(i&&e.altKey){h(`Contextemnu on: ${i}`);let l=new b.Menu("MoveMenu");l.addItem(new b.MenuItem({label:B.Menu.Move,type:"submenu",icon:"iconMove",submenu:this.createMenuItems(i)})),l.showAtMouseEvent(e)}}createMenuItems(e){let n=[];for(let o of this.notebooks){let i={label:o.name,icon:`icon-${o.icon}`,click:l=>{h(`Move ${e} to ${o.id}`),Et(e,o)}};n.push(i)}return n}}const xt="toolbar__item b3-tooltips b3-tooltips__sw";class Tt extends b.Plugin{constructor(){super(),h(`Start: ${new Date}`),N.setPlugin(this),this.notebooks=[],this.selectFolded=!0,this.div_select=document.createElement("div"),this.div_select.setAttribute("aria-label","Open Today's Diary"),this.div_select.classList.add(...xt.split(/\s/)),this.div_select.style.margin="0 0.5rem",this.div_select.style.padding="0rem 0rem",this.menu=new Dt(this.notebooks)}async onload(){let e=performance.now();await this.initNotebooks(),this.registerCommand({command:"updateAll",shortcut:"ctrl+alt+u,command+option+u",description:"全局更新",callback:this.updateAll.bind(this)}),await N.load(),this.initSetting(),this.initMenu(),this.component_select=new yt({target:this.div_select,props:{notebooks:this.notebooks}}),this.component_select.$on("openSelector",this.updateDiaryStatus_.bind(this)),this.component_select.$on("openDiary",async o=>{await Te(o.detail.notebook),this.updateDiaryStatus_()}),b.clientApi.addToolbarRight(this.div_select),await this.updateDiaryStatus_(),this.notebooks.length>0&&(this.component_select.$set({selected:this.notebooks[0].id}),N.settings.OpenOnStart===!0&&Te(this.notebooks[0]));let n=performance.now();h(`Onload, 耗时: ${n-e} ms`)}initSetting(){this.div_setting=document.createElement("div"),this.component_setting=new St({target:this.div_setting,props:{contents:B.Setting}}),this.registerSettingRender(e=>{e.appendChild(this.div_setting)}),this.component_setting.$on("updateAll",()=>{this.updateAll()})}initMenu(){this.menu.notebooks=this.notebooks,this.menu.bindMenuOnCurrentTabs(),this.menu.addEditorTabObserver()}async initNotebooks(){let n=0;for(;n<5;){let o=await De();if(o!=null){this.notebooks=o;break}else await new Promise(i=>setTimeout(i,1e3));n++}}async updateAll(){h("updateAll");let e=await De();this.notebooks=e||[],this.component_select.$set({notebooks:this.notebooks}),await this.updateDiaryStatus_(),this.menu.notebooks=this.notebooks,this.menu.bindMenuOnCurrentTabs(),ee(B.UpdateAll,"info",2500)}async updateDiaryStatus_(){h("updateDiaryStatus");let e=new Set;this.notebooks.forEach(i=>{e.add(i.dailynotePath)});let n=new Map,o=0;for(const i of e){let l=await _e(i);if(l.length>0){let s=l.map(c=>c.box);s.forEach(c=>{n.set(c,!0)}),o+=s.length,h(`${i} 共 ${s.length} 篇`)}}this.component_select.$set({diaryStatus:n}),h(`当前日记共 ${o} 篇`)}onunload(){h("plugin unload"),this.component_select.$destroy(),this.div_select.remove()}}module.exports=Tt;
